---
title: "LTAW_Moment cleaning"
author: "Kristina Dale"
date: "2023-08-02"
output:
  html_document:
    code_folding: hide
    df_print: paged
    highlight: tango
    theme: united
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache = TRUE)
options(scipen=999)
```

# Scope
1. Basic cleaning of moment data
    Summary of moment completion
    Moment "scoring"
2. cleaned moments - csv

# load packages
```{r}
if(!require('pacman')) {
	install.packages('pacman')
}

pacman::p_load(tidyverse, labelled, devtools, plyr, haven, expss, DT, qwraps2, gtsummary, remotes, readxl, retidytext, openxlsx, reactable, reactablefmtr, ggwordcloud, topicmodels, here, install = TRUE)
```

# define aesthetics
```{r}
palette = c("#772e25", "#c44536", "#ee9b00", "#197278", "#283d3b", "#9CC5A1", "#ADA7C9", "grey50")
palette_type = c("#c44536", "#ee9b00", "#197278")
palette_pilot = c("#c44536", "#197278")
palette_sentiment = c(palette[2], palette[4])
plot_aes = theme_minimal() +
  theme(legend.position = "top",
        legend.text = element_text(size = 8),
        text = element_text(size = 12, family = "Futura Medium"),
        axis.text = element_text(color = "black"),
        axis.ticks.y = element_blank())
```

## load & tidy audio (moment) data 
*NOTE for iteration: in the future i think the process of getting the moment data, regardless of source will be a bit different, and this step may be replaced by a database query*
moments collected via CameraTag, see study detail page for details[link]. Raw data comes from AWS transcription service, script from Mike M.
```{r}
#moments <- read.csv("/Users/kristina/Documents/Surveys/NEW /Lets Talk About Wellbeing/Raw Data/_a-b14b7c20-5f43-013b-1cdd-02c7c2460d41_full.csv")
moments <- read.csv(here("inputs", "_a-b14b7c20-5f43-013b-1cdd-02c7c2460d41_full.csv"))


moments_split <- data.frame(do.call(rbind, strsplit(sub('_', ',', moments$name), ',', fixed = TRUE)))
colnames(moments_split) <- c("userid", "itemid")
moments <- cbind(moments, moments_split)

moments_tidy = moments %>%
  filter(!grepl("test", userid, ignore.case = TRUE)) %>% # tests
  filter(!grepl("test", itemid, ignore.case = FALSE)) %>% # tests
  filter(nchar(userid) > 1) %>% # remove test responses
  select(-c(description, ip)) #remove cols 

#missing ID check
count(moments_tidy$userid=="")

#incorrect ID check
moments_tidy %>%
  filter(nchar(userid) != 24)

#organize
moments_tidy <- moments_tidy[c(2,11,12,3:10,1)] 
```

## Prolific status check

2539 out of 2573 participants on prolific were included in this merge
```{r}
#prolific <- read.csv("/Users/kristina/Downloads/prolific_export_639e73b38884ae6555e593ca.csv")
prolific <- read.csv(here("inputs", "prolific_export_639e73b38884ae6555e593ca.csv")) 
colnames(prolific)<-paste(colnames(prolific),"prolific",sep="_")
colnames(prolific)[2] <- "userid"


# merge prolific data
moments_merge <- moments_tidy %>% 
  left_join(prolific, by = "userid")
  
length(unique(moments$userid))
```


In total, 23 responses were removed. 
```{r}
#already read in above qualtrics section



#moments_tidy <- merge(moments_tidy, prolific, all = T)
moments_merge$Status_prolific <-moments_merge$Status_prolific %>% replace_na('TIMEDOUT')

#summarize returned responses
data_remove_moments <- moments_merge %>%
  select(userid, itemid, transcript, duration, number_of_words, mp3_url, recorded_from, app_uuid, uuid, Status_prolific, Submission.id_prolific) %>%
  unique() %>%
  filter(Status_prolific =="RETURNED") %>%
  group_by(userid, itemid, Status_prolific) %>%
  mutate(detials = "") 

data_remove_moments<- data_remove_moments[order(data_remove_moments$userid),]

data_remove_moments 

moments_tidy = moments_merge %>%
  filter(!Status_prolific == "RETURNED") # remove returned moments 
```

# Summarize moments data: total attempted, total valid {.tabset}
total_attempted = total moments submitted (exlcuding PromptTest)
total_invalid = total moments where duration=none (excluding PromptTest)
total_valid = total_attempted - total_invalid
valid_moment = TRUE --> duration != none & itemid != PromptTest
             = FALSE --> duration = none OR itemid = PromptTest OR no moment data (NA)

## total valid 
```{r}
#adding totals for moments attempted/completed (valid)
moments_totals <- dcast(unique(moments_tidy), formula = userid ~ itemid, fun.aggregate = length) %>%
  select(-c(PromptTest)) #exclude prompt_test
moments_totals <- cbind(moments_totals, total_attempted = rowSums(moments_totals[ , 2:22])) 
moments_totals <- select(moments_totals, userid, total_attempted)
moments_tidy <- merge(moments_tidy,moments_totals)

invalid_moments <- moments_tidy %>% filter(duration=="none")
invalid_moments_totals <- dcast(unique(invalid_moments), formula = userid ~ itemid, fun.aggregate = length) %>%
  select(-c(PromptTest)) #exclude prompt_test

invalid_moments_totals <- cbind(invalid_moments_totals, total_invalid = rowSums(invalid_moments_totals[ , 2:22]))
invalid_moments_totals <- select(invalid_moments_totals, userid, total_invalid)
moments_tidy <- merge(moments_tidy, invalid_moments_totals, all=T)

moments_tidy$total_invalid <-moments_tidy$total_invalid %>% replace_na(0)
moments_tidy$total_valid <- (moments_tidy$total_attempted - moments_tidy$total_invalid)

#flag for invalid moment
moments_tidy$valid_moment <- ifelse(moments_tidy$duration=="none" | moments_tidy$itemid=="PromptTest", "FALSE", "TRUE")
moments_tidy$valid_moment <-moments_tidy$valid_moment %>% replace_na("FALSE")

moments_tidy %>%
  select(itemid, userid, valid_moment) %>%
  mutate(valid_moment = ifelse(valid_moment == "TRUE", "valid", "invalid")) %>%
  group_by(valid_moment) %>%
  mutate(count = length(valid_moment)) %>%
  dplyr::summarize(n = n()) %>%
  spread(valid_moment, n) %>%
  mutate(percent_valid = round((valid / (invalid+valid)) * 100, 1))
```


## deduplication & duplicates summary
Duplication in moment data could have happened if the participant accessed and started the Qualtrics study multiple times, thus accessing the prompts multiple times. 
*In this particular study, participants were randomly presented with a subset (1/5 Narrative, 5/15 Well-being) of a larger pool of possible prompt options + 1 Goal prompt*, so it is possible that even though they accessed the study at multiple points, they did not complete the same prompt(s) twice due to randomization. Because of this, we flag only duplicated itemid's as dupes within a given participant. We retain all duplicated data and flag each response. If the moment it's 

```{r}

ID_counts_moments <- data.frame(table(moments_tidy$name)) 
ID_counts_moments<- ID_counts_moments[order(ID_counts_moments$Var1),]

moments_dupes <- ID_counts_moments[ID_counts_moments$Freq > 1,] 
colnames(moments_dupes) <- c("name", "Freq")
dup_id <- as.vector(moments_dupes$name)

#get & flag duplicate data 
moments_tidy <- moments_tidy %>%
  mutate(dupe_survey = case_when(userid %in% dup_id & valid_moment == TRUE ~ TRUE,
                                 userid %in% dup_id & valid_moment == FALSE ~ NA,
                                  TRUE ~ FALSE)) %>%
  select(userid, valid_moment, dupe_survey)


# dupes_moments <- c(moments_dupes$name)
# dupes_moments <- moments_tidy[moments_tidy$name %in% dupes_moments,] 
# dupes_moments$dupe_moment <- "TRUE"
# 
# #merge flagged dupes back into tidy df & flag non-dupes in tidy df 
# moments_tidy <- moments_tidy[!moments_tidy$name %in% dupes_moments$name,] 
# moments_tidy$dupe_moment <- "FALSE"
# moments_tidy <- merge(moments_tidy, dupes_moments, all = T)
# moments_tidy <- moments_tidy[order(moments_tidy$userid),]

#summarize duplicate responses
moments_tidy %>%
  select(userid, itemid, transcript, dupe_moment) %>%
  unique() %>%
  filter(dupe_moment =="TRUE") %>%
  group_by(userid) %>%
  group_by(userid) %>%
  add_count(userid, itemid)
```

## by prompt 
```{r}
moments_tidy %>%
  filter(grepl("TRUE", valid_moment)) %>%
  group_by(itemid, valid_moment) %>%
  dplyr::summarize(n = n()) %>%
  spread(valid_moment, n)
```

## by prompt category
*NOTE: theres probably an easier way to do this where we have some larger prompt library sheet where all of these categories/labels are pre-defined, then we can read that in here and merge by itemid -- but for now, its done manually using the study outline*
```{r}
moments_tidy$prompt_category <- ifelse(grepl("WB", moments_tidy$itemid), "Well-being", "") 
moments_tidy$prompt_category <- ifelse(grepl("Narr", moments_tidy$itemid), "Narrative", moments_tidy$prompt_category) 
moments_tidy$prompt_category <- ifelse(grepl("Goal", moments_tidy$itemid), "Goals", moments_tidy$prompt_category) 
moments_tidy$prompt_category <- ifelse(grepl("Test", moments_tidy$itemid), "Test", moments_tidy$prompt_category) 

moments_tidy %>%
  filter(grepl("TRUE", valid_moment)) %>%
  group_by(prompt_category) %>%
  dplyr::summarize(n = n()) %>%
  spread(prompt_category, n)

```

## by prompt construct
```{r}
moments_tidy <- moments_tidy %>% #define constructs from study outline
  mutate(
    prompt_construct = case_when(
      itemid == "PromptNarr_1" ~ "Problem-solving",
      itemid == "PromptNarr_2" ~ "Identity",
      itemid == "PromptNarr_3" ~ "Bitterness revival",
      itemid == "PromptNarr_4" ~ "Competence building redemption",
      itemid == "PromptNarr_5" ~ "Competence building agency",
      itemid == "PromptWB_1" ~ "Autonomy",
      itemid == "PromptWB_2" ~ "Clear thinking",
      itemid == "PromptWB_3" ~ "Competence",
      itemid == "PromptWB_4" ~ "Emotional stability",
      itemid == "PromptWB_5" ~ "Empathy",
      itemid == "PromptWB_6" ~ "Engagement",
      itemid == "PromptWB_7" ~ "Meaning",
      itemid == "PromptWB_8" ~ "Optimism",
      itemid == "PromptWB_9" ~ "Positive emotions",
      itemid == "PromptWB_10" ~ "Positive relationships",
      itemid == "PromptWB_11" ~ "Prosocial behavior",
      itemid == "PromptWB_12" ~ "Resilience",
      itemid == "PromptWB_13" ~ "Self-acceptance",
      itemid == "PromptWB_14" ~ "Self-esteem",
      itemid == "PromptWB_15" ~ "Vitality",
      itemid == "PromptGoal" ~ "Goals",
      TRUE ~ NA_character_
    ))

moments_tidy %>%
  filter(grepl("TRUE", valid_moment)) %>%
  group_by(prompt_construct, prompt_category) %>%
  dplyr::summarize(n = n()) %>%
  spread(prompt_category, n)


```

# label moment data
add item text column 
```{r}
moments_tidy <- moments_tidy %>% 
  mutate(
    itemtext = case_when(
      itemid == "PromptNarr_1" ~ "Talk about a time in your past when you successfully coped with a challenge.",
      itemid == "PromptNarr_2" ~ "Talk about an event or experience in your past that was meaningful and helped shape how you became the person that you are.",
      itemid == "PromptNarr_3" ~ "Talk about a negative experience in your past when you were disappointed in yourself, in conflict with someone else, or for some other reason have regrets.",
      itemid == "PromptNarr_4" ~ "Talk about a time you failed and at least one way this failure changed you for the better.",
      itemid == "PromptNarr_5" ~ "Talk about a time you succeeded and describe the steps you took to make this success a reality.",
      itemid == "PromptWB_1" ~ "What is keeping you from pursuing the things you want to pursue in life?",
      itemid == "PromptWB_2" ~ "Describe a time when you were very focused on a task.",
      itemid == "PromptWB_3" ~ "Talk about whether you feel able to manage difficulties in your life.",
      itemid == "PromptWB_4" ~ "Describe an event that recently made you upset. What did that feel like for you?",
      itemid == "PromptWB_5" ~ "Describe a time when you talked with another person about their problems.",
      itemid == "PromptWB_6" ~ "Describe a recent activity or hobby that you enjoyed.",
      itemid == "PromptWB_7" ~ "To what extent do you feel like your life is moving in the right direction?",
      itemid == "PromptWB_8" ~ "Do you feel optimistic about the future? Talk about it.",
      itemid == "PromptWB_9" ~ "Talk about something that usually makes you happy.",
      itemid == "PromptWB_10" ~ "Is there a community, online or in person, that you feel you have become a part of?",
      itemid == "PromptWB_11" ~ "Talk about a time when you sacrificed for someone else.",
      itemid == "PromptWB_12" ~ "Describe a time you had a significant life difficulty, and how you reacted to it.",
      itemid == "PromptWB_13" ~ "How do you treat yourself when you make mistakes?",
      itemid == "PromptWB_14" ~ "How would you describe yourself as a person?",
      itemid == "PromptWB_15" ~ "Talk about a time when you felt truly happy and alive.",
      itemid == "PromptGoal" ~ "If your goal was a more satisfying life, what would be your first step towards that goal?",
      itemid == "PromptTest" ~ "Using the microphone widget below, please record the following: Hello, this is a test recording.",
      TRUE ~ NA_character_
    ))

#organize
#moments_cleaned <- moments_tidy[c(1,3,39,4:12,32,36:38,13:31,33:35)]
moments_cleaned <- moments_tidy
moments_cleaned$source <- "Lets talk about wellbeing"
```

# generate a prompt dictionary
```{r}
prompt_dict <- moments_tidy %>%
  select(itemid, prompt_category,itemtext) %>%
  unique() %>%
  filter(!prompt_category == "Test") %>%
  arrange(prompt_category) %>%
  mutate(prompt_id = sprintf("prompt_%02d", row_number())) %>%
  mutate(ltaw = TRUE)
```



```{r}
#write.csv(moments_cleaned, "/Users/kristina/Documents/Surveys/NEW /Lets Talk About Wellbeing/LTAW_moments_cleaned.csv")

#write.csv(moments_cleaned, here("outputs", "ltaw_moments_cleaned.csv"), row.names = F)
#write.csv(prompt_dict, here("outputs", "prompt_dict.csv"), row.names = F)
```
